<link rel="import" href="../../polymer/polymer-element.html" />
<link rel="import" href="../../polymer/lib/elements/dom-if.html" />
<link rel="import" href="../../polymer/lib/elements/dom-repeat.html" />
<link rel="import" href="input.html" />
<link rel="import" href="theme.html" />

<dom-module id="hakuneko-menu">
  <template>
    <style>
      :host {
        height: 2rem;
      }

      .menu {
        display: flex;
        flex-direction: row;
        width: 100%;
        background: linear-gradient(
            180deg,
            var(--base) calc(100% - 1px),
            transparent calc(100% - 1px)
          ),
          linear-gradient(90deg, var(--accent) 50%, transparent), var(--base);
      }

      .item {
        margin: 0.25rem;
        cursor: pointer;
      }

      .title {
        font-weight: bold;
        font-size: 1rem;
        color: var(--accent);
        display: flex;
        flex: 1;
        justify-content: center;
        align-items: center;
      }

      .popup {
        display: flex;
        flex-direction: column;
        position: absolute;
        top: 0;
        background: var(--base);
        margin: 3rem 0 0 1rem;
        height: calc(100% - 4rem);
        transition: 0.2s linear all;
        z-index: 10;
        width: calc(30rem + 2px);
        border: 1px solid var(--accent);
        border-radius: var(--border-radius);
        overflow: hidden;
      }

      .appearance {
        transition: 0.2s linear all;
        position: absolute;
        z-index: 100;
        padding: 0.5rem;
        width: 16rem;
        display: flex;
        flex-direction: column;
        box-shadow: 0 0 0 1px var(--accent);
        background: var(--base);
        border-radius: var(--border-radius);
        right: -17rem;
        top: 2.2rem;
      }

      .appearance__colors {
        display: flex;
        flex-flow: row wrap;
      }
      .appearance__radius {
        display: flex;
        flex-direction: row;
      }

      .appearance__colors_item {
        width: 4rem;
        height: 3rem;
        border-radius: 0 0.5rem;
        background: whitesmoke;
        margin: 0.5rem;
        cursor: pointer;
        display: flex;
        align-items: flex-end;
        overflow: hidden;
      }

      .appearance__colors_item--label {
        font-size: 0.5rem;
        font-weight: 900;
        width: 100%;
        background: #00000077;
        height: 1rem;
        display: flex;
        justify-content: center;
        align-items: center;
        text-transform: uppercase;
        color: var(--text);
      }

      .appearance__corner {
        display: flex;
        justify-content: space-around;
        margin: 0.5rem 0;
        border-top: 1px solid var(--accent);
        padding-top: 1rem;
      }

      .appearance__corner_item {
        display: flex;
        align-items: center;
        width: calc(50% - 1rem);
        height: 2.25rem;
        padding-left: .25rem;
        background: var(--accent);
        text-transform: uppercase;
        color: var(--text);
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        overflow: hidden;
        text-shadow: 0 0 .5rem;
      }

      .appearance__corner_item.square {
        border-radius: 0;
      }
      .appearance__corner_item.rounded {
        border-radius: 0.5rem;
      }

      .appearance__colors_item.selected,
      .appearance__corner_item.selected {
        position: relative;
      }

      .appearance__colors_item.selected:after,
      .appearance__corner_item.selected:after {
        position: absolute;
        top: 0;
        right: 0;
        width: 1.25rem;
        height: 1.25rem;
        background: #00000077;
        color: var(--accent);
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: "Material Design Icons";
        font-size: .7rem;
        content:"\F04CE";
      }

      .appearance.show {
        right: 7.5rem;
      }

      .popup.show {
        left: 0;
      }

      .popup.hide {
        left: -35.25rem;
      }

      .separator {
        font-weight: bold;
        height: 2rem;
        padding: 0 0.5rem;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        background: var(--accent);
        color: var(--text);
      }

      .about {
        display: flex;
        flex-direction: row;
        margin: 0.5rem;
      }

      .logo {
        display: flex;
        width: 10rem;
        background: var(--accent);
        border: 1px solid var(--accent);
        border-radius: var(--border-radius);
        overflow: hidden;
      }

      .logo img {
        width: 100%;
        height: 100%;
        border-radius: var(--border-radius);
      }

      .info {
        flex: 1;
        margin-left: 0.5rem;
        display: flex;
      }

      .credits {
        background-color: var(--base);
        padding: 0.5rem;
        border: 1px solid var(--accent);
        width: 100%;
        display: flex;
        flex-direction: column;
        height: 100%;
        color: var(--text);
        border-radius: var(--border-radius);
      }

      .credits__info {
        border-bottom: 1px solid var(--accent);
        padding-bottom: 0.5rem;
      }

      .people {
        width: 100%;
        display: flex;
        flex-direction: column;
        flex: 1;
        justify-content: center;
      }
      .people__item {
        display: flex;
        flex-direction: row;
        margin-top: 0.5rem;
        flex: 1;
        align-items: center;
      }

      .people__item:last-child {
        margin-bottom: 0;
      }

      .people__item_title {
        flex: 2;
      }

      .people__item_info {
        flex: 3;
        margin-left: 0.5rem;
      }

      .people__item_info .link .icon {
        margin-right: 0.5rem;
      }

      .people__item_info--icon {
        width: 18px;
        height: 18px;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        color: var(--accent);
        margin-right: 0.5rem;
      }

      .settings {
        flex: 1;
        overflow-y: auto;
        background-color: var(--base);
        padding: 0.5rem;
      }

      .settings__group {
        display: flex;
        flex-direction: column;
        border-top: 1px solid var(--accent);
        margin-bottom: 0.5rem;
      }

      .settings__group:first-child {
        border: none;
      }

      .settings__group:last-child {
        margin-bottom: 0;
      }

      .settings__group_title {
        width: 100%;
        padding: 0.5rem;
        text-align: center;
        text-transform: uppercase;
        color: var(--accent);
        font-weight: bold;
      }

      .settings__group_options {
        display: flex;
        flex-direction: row;
        align-items: center;
      }

      .settings__group_options--label {
        flex: 1;
        color: var(--text);
      }

      .settings__group_options--input {
        flex: 1;
      }

      .group {
        font-weight: bold;
        color: var(--menu-control-category-color);
        padding: 0.5rem;
        text-align: center;
        text-transform: uppercase;
      }

      .link {
        display: inline-flex;
        align-items: center;
        color: var(--accent);
      }

      .button {
        cursor: pointer;
        -webkit-app-region: no-drag;
        width: 2rem;
        height: 2rem;
        display: flex;
        justify-content: center;
        align-items: center;
        color: var(--accent);
      }

      .button.close:hover {
        background: #cf0420;
        color: var(--text);
      }

      .button:hover {
        background: #ffffff15;
      }

      .right {
        display: flex;
        flex-direction: row;
      }

      .right .button {
        width: 2.5rem;
      }

      .buttons {
        display: flex;
        height: 2.5rem;
        padding: 0.25rem;
        background: var(--accent);
      }

      .buttons .button {
        width: 2rem;
        height: 2rem;
        color: var(--text);
      }

      .buttonsLeft {
        flex: 1;
      }

      .buttonsRight {
        display: flex;
        flex-direction: row;
      }

      .buttonsRight .button {
        margin-left: 0.5rem;
      }

      #importFile {
        display: none;
      }
    </style>
    <style include="theme"></style>
    <div class="menu">
      <i
        class="mdi mdi-24px mdi-menu button"
        title="Toggle menu"
        on-click="togglePopup"
      ></i>
      <span class="title">HakuNeko</span>
      <span class="right">
        <i
          class="mdi mdi-18px mdi-reload button"
          title="Close HakuNeko"
          onclick="windowReload()"
        ></i>
        <i
          class="mdi mdi-18px mdi-palette-swatch button"
          title="Close HakuNeko"
          on-click="togglePopupAppearance"
        ></i>
        <i
          class="mdi mdi-18px mdi-window-minimize button"
          title="Minize HakuNeko"
          onclick="minimizeWindow()"
        ></i>
        <i
          class="mdi mdi-18px mdi-window-maximize button"
          title="Maximize HakuNeko"
          onclick="maximizeWindow()"
        ></i>
        <i
          class="mdi mdi-18px mdi-window-close button close"
          title="Close HakuNeko"
          onclick="closeWindow()"
        ></i>
      </span>
      <div class$="popup [[ getPopupClass(popupVisibility) ]]">
        <div class="separator">
          <label>About</label>
        </div>
        <div class="about">
          <div class="logo">
            <img src="./img/logo_m.png" />
          </div>
          <div class="info">
            <div class="credits">
              <div class="credits__info">
                &copy; [[ year ]]
                <a
                  class="link"
                  on-click="openWindow"
                  title="https://git.io/hakuneko"
                  data-href="https://git.io/hakuneko"
                >
                  HakuNeko
                </a>
                rev.
                <a
                  class="link"
                  on-click="openWindow"
                  title="Revision History"
                  data-href$="[[ version.revision.link ]]"
                >
                  [[ version.branch.label ]]@[[ version.revision.label ]]
                </a>
              </div>
              <div class="people">
                <div class="people__item">
                  <div class="people__item_title">Development:</div>
                  <div class="people__item_info">
                    <a
                      class="link"
                      on-click="openWindow"
                      data-href="https://github.com/orgs/manga-download/people"
                      ><i class="icon mdi mdi-18px mdi-account-group"></i
                      >Maintainers</a
                    ><br />
                    <a
                      class="link"
                      on-click="openWindow"
                      data-href="https://github.com/manga-download/hakuneko/graphs/contributors"
                      ><i class="icon mdi mdi-18px mdi-lightbulb-group"></i
                      >Contributors</a
                    >
                  </div>
                </div>
                <div class="people__item">
                  <div class="people__item_title">Artwork:</div>
                  <div class="people__item_info">
                    <a
                      class="link"
                      on-click="openWindow"
                      data-href="https://www.deviantart.com/hakuneko3kune"
                      ><i class="icon mdi mdi-18px mdi-cat"></i>HakuNeko3Kune</a
                    >
                  </div>
                </div>
                <div class="people__item">
                  <div class="people__item_title">Help & Info:</div>
                  <div class="people__item_info">
                    <i
                      class="people__item_info--icon mdi mdi-18px mdi-home"
                      on-click="openWindow"
                      title="Visit the HakuNeko Homepage"
                      data-href="https://hakuneko.download"
                    ></i>
                    <i
                      class="people__item_info--icon mdi mdi-18px mdi-book-open-page-variant"
                      on-click="openWindow"
                      title="Read the Online Documentation"
                      data-href="https://hakuneko.download/docs/interface/"
                    ></i>
                    <i
                      class="people__item_info--icon mdi mdi-18px mdi-bug"
                      on-click="openWindow"
                      title="Open a Ticket on GitHub"
                      data-href="https://hakuneko.download/docs/troubleshoot/"
                    ></i>
                    <i
                      class="people__item_info--icon mdi mdi-18px mdi-discord"
                      on-click="openWindow"
                      title="Login to the Community Support Channel"
                      data-href="https://discordapp.com/invite/A5d3NDf"
                    ></i>
                    <i
                      class="people__item_info--icon mdi mdi-18px mdi-google-street-view"
                      on-click="openWindow"
                      title="Show your external IP and Geolocation"
                      data-href="https://ipinfo.io/json"
                    ></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="separator">
          <label>Settings</label>
        </div>
        <div class="settings">
          <template is="dom-repeat" items="[[ settingCategories ]]">
            <div class="settings__group">
              <div class="settings__group_title">[[ item.category ]]</div>
              <template is="dom-repeat" items="[[ item.settings ]]">
                <div class="settings__group_options">
                  <div
                    class="settings__group_options--label"
                    title="[[ item.description ]]"
                  >
                    [[ item.label ]]
                  </div>
                  <div class="settings__group_options--input">
                    <hakuneko-input
                      class$="[[ getAppearance ]]"
                      item="{{ item }}"
                    >
                    </hakuneko-input>
                  </div>
                </div>
              </template>
            </div>
          </template>
        </div>
        <div class="buttons">
          <div class="buttonsLeft">
            <i
              class="mdi mdi-24px mdi-file-import button"
              title="Import bookmarks"
              on-click="import"
            ></i>
            <input
              type="file"
              id="importFile"
              accept="application/x-sqlite3,.db,.db3"
              on-change="onImport"
            />
          </div>
          <div class="buttonsRight">
            <i
              class="mdi mdi-content-save-cog mdi-24px button"
              title="Save settings and close menu"
              on-click="closeSaveChanges"
            ></i>
            <i
              class="mdi mdi-24px mdi-close-box button"
              title="Close menu without saving settings"
              on-click="closeDiscardChanges"
            ></i>
          </div>
        </div>
      </div>
      <div
        class$="appearance [[ getPopupClassAppearance(popupVisibilityAppearance) ]]"
      >
        <div class="appearance__colors">
          <template is="dom-repeat" items="[[ themes ]]">
            <div
              class$="appearance__colors_item [[ getThemeSelected(item.label) ]]"
              on-click="setTheme"
              style$="background: [[ item.color ]]"
            >
              <div
                style$="color: [[ item.color ]]"
                class="appearance__colors_item--label"
              >
                [[ item.label ]]
              </div>
            </div>
          </template>
        </div>
        <div class="appearance__corner">
          <template is="dom-repeat" items="[[ corners ]]">
            <div
              class$="appearance__corner_item [[ item.class ]] [[ getCornerSelected(item.value) ]]"
              on-click="setCorner"
            >
              [[item.label]]
            </div>
          </template>
        </div>
      </div>
    </div>
  </template>

  <script>
    class HakunekoMenu extends Polymer.Element {
      static get is() {
        return "hakuneko-menu";
      }

      static get properties() {
        return {};
      }

      ready() {
        super.ready();
        this.year = new Date().getFullYear();
        this.version = Engine.Version;
        this.popupVisibility = false;
        this.popupVisibilityAppearance = false;
        this.settingCategories = Engine.Settings.getCategorizedSettings();
        this.corners = [
          {
            label: "straight corner",
            class: "square",
            value: "corner__square",
          },
          {
            label: "rounded corner",
            class: "rounded",
            value: "corner__rounded",
          },
        ];
        this.themes = [
          { label: "red", color: "#F44336" },
          { label: "pink", color: "#E91E63" },
          { label: "purple", color: "#9C27B0" },
          { label: "dpurple", color: "#673AB7" },
          { label: "indigo", color: "#3F51B5" },
          { label: "blue", color: "#2196F3" },
          { label: "cian", color: "#00BCD4" },
          { label: "teal", color: "#009688" },
          { label: "green", color: "#4CAF50" },
          { label: "lgreen", color: "#8BC34A" },
          { label: "lime", color: "#CDDC39" },
          { label: "yellow", color: "#FFEB3B" },
          { label: "amber", color: "#FFC107" },
          { label: "orange", color: "#FF9800" },
          { label: "dorange", color: "#FF5722" },
        ];
      }

      getCornerSelected(value) {
        return localStorage.getItem("corner") === value
          ? "selected"
          : "";
      }

      getThemeSelected(theme) {
        return localStorage.getItem("themeColor") === theme ? "selected" : "";
      }

      getPopupClass(visibility) {
        return visibility ? "show" : "hide";
      }

      getPopupClassAppearance(visibility) {
        return visibility ? "show" : "hide";
      }

      async togglePopup() {
        let visible = !this.popupVisibility;
        if (visible) {
          this.set(
            "settingCategories",
            Engine.Settings.getCategorizedSettings()
          );
        } else {
          this.set("settingCategories", []);
        }
        this.set("popupVisibility", visible);
      }

      async togglePopupAppearance() {
        let visible = !this.popupVisibilityAppearance;
        if (visible) {
          this.set(
            "settingCategories",
            Engine.Settings.getCategorizedSettings()
          );
        } else {
          this.set("settingCategories", []);
        }
        this.set("popupVisibilityAppearance", visible);
      }

      closeDiscardChanges() {
        Engine.Settings.load();
        this.set("settingCategories", []);
        this.set("popupVisibility", false);
      }

      closeSaveChanges() {
        Engine.Settings.save();
        this.set("settingCategories", []);
        this.set("popupVisibility", false);
      }

      setTheme(e) {
        localStorage.setItem("themeColor", e.model.item.label);
        window.location.reload();
      }

      setCorner(e) {
        localStorage.setItem("corner", e.model.item.value);
        window.location.reload();
      }

      /**
       * Open a new window and always disable the "Stay or Leave" confirmation,
       * otherwise the window cannot be closed anymore (electron does not show the confirmation).
       */
      openWindow(event) {
        let popup = window.open(
          event.target.dataset.href,
          "",
          "frame=true,nodeIntegration=no"
        );
        // disable onbeforeunload periodically (in case of navigation) to prevent blocking window close
        let watchdog = setInterval(() => {
          if (popup.closed) {
            clearInterval(watchdog);
          } else {
            let script = `
              // loal scope for variable declaration
              {
                  window.onbeforeunload = evt => undefined;
                  let warning = document.querySelector('div.unsupported-browser');
                  if(warning) {
                      warning.parentNode.removeChild(warning);
                  }
                  let signup = document.querySelector('div.signup-prompt');
                  if(signup) {
                      signup.parentNode.removeChild(signup);
                  }
              }
          `;
            popup.eval(script);
          }
        }, 500);
      }

      import(event) {
        this.$.importFile.click();
      }

      onImport(event) {
        try {
          Engine.BookmarkManager.importBookmarks(event.target.files[0]);
        } catch (error) {
          alert(error.message);
        } finally {
          // reset input file field or it cannot be used again
          this.$.importFile.value = null;
        }
      }
    }
    window.customElements.define(HakunekoMenu.is, HakunekoMenu);
  </script>
</dom-module>
